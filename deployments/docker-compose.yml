services:
  # Kafka в режиме KRaft (без Zookeeper)
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: telegram-news-kafka
    ports:
      - "9092:9092"
      - "9093:9093"
    environment:
      # KRaft режим
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9094
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER

      # Listeners
      KAFKA_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://0.0.0.0:9093,CONTROLLER://kafka:9094
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT

      # Настройки кластера
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"

      # Директория для логов
      KAFKA_LOG_DIRS: /var/lib/kafka/data

      # Cluster ID (должен быть уникальным для каждого кластера)
      CLUSTER_ID: MkU3OEVBNTcwNTJENDM2Qk
    networks:
      - telegram-news-network
    volumes:
      - kafka-data:/var/lib/kafka/data
    command:
      - bash
      - -c
      - |
        if [ ! -f /var/lib/kafka/data/meta.properties ]; then
          /usr/bin/kafka-storage format -t $${CLUSTER_ID} -c /etc/kafka/kraft/server.properties
        fi
        /etc/confluent/docker/run

  # Account Service - управление Telegram аккаунтами и сбор новостей
  account-service:
    build:
      context: ../services/account-service
      dockerfile: Dockerfile
    container_name: telegram-news-account-service
    depends_on:
      - kafka
      - postgres
    env_file:
      - ../services/account-service/.env
    environment:
      # Database Configuration
      DATABASE_HOST: postgres
      DATABASE_PORT: "5432"
      DATABASE_USER: accounts_user
      DATABASE_PASSWORD: accounts_pass
      DATABASE_NAME: accounts_db
      DATABASE_SSLMODE: disable

      # Telegram Configuration (API credentials from env_file)
      TELEGRAM_SESSION_DIR: /app/sessions
      TELEGRAM_MIN_REQUIRED_ACCOUNTS: ${TELEGRAM_MIN_REQUIRED_ACCOUNTS:-1}

      # Kafka Configuration
      KAFKA_BROKERS: kafka:9092
      KAFKA_GROUP_ID: account-service-group
      KAFKA_TOPIC_NEWS_RECEIVED: news.received
      KAFKA_TOPIC_SUBSCRIPTIONS_CREATED: subscriptions.created
      KAFKA_TOPIC_SUBSCRIPTIONS_DELETED: subscriptions.deleted

      # Service Configuration
      SERVICE_NAME: account-service
      SERVICE_PORT: 8084
      SERVICE_SHUTDOWN_TIMEOUT: 30s

      # News Collection Settings
      NEWS_POLL_INTERVAL: ${NEWS_POLL_INTERVAL:-30s}
      NEWS_COLLECTION_TIMEOUT: ${NEWS_COLLECTION_TIMEOUT:-5m}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
    volumes:
      # Persistent storage for Telegram sessions
      - account-sessions:/app/sessions
      # Optional: mount for logs
      - account-logs:/app/logs
    networks:
      - telegram-news-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pgrep account-service || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Subscription Service - управление подписками пользователей
  subscription-service:
    build:
      context: ..
      dockerfile: services/subscription-service/Dockerfile
    container_name: telegram-news-subscription-service
    depends_on:
      - kafka
      - postgres
    environment:
      DATABASE_HOST: postgres
      DATABASE_PORT: "5432"
      DATABASE_USER: subscriptions_user
      DATABASE_PASSWORD: subscriptions_pass
      DATABASE_NAME: subscriptions_db
      DATABASE_SSLMODE: disable
      KAFKA_BROKERS: kafka:9092
      KAFKA_GROUP_ID: subscription-service-group
      SERVICE_NAME: subscription-service
      SERVICE_PORT: "8082"
      GRPC_PORT: "50051"
      LOG_LEVEL: ${LOG_LEVEL:-info}
    networks:
      - telegram-news-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pgrep subscription-service || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # News Service - обработка и доставка новостей
  news-service:
    build:
      context: ../services/news-service
      dockerfile: Dockerfile
    container_name: telegram-news-news-service
    depends_on:
      - kafka
      - postgres
      - subscription-service
    environment:
      DATABASE_HOST: postgres
      DATABASE_PORT: "5432"
      DATABASE_USER: news_user
      DATABASE_PASSWORD: news_pass
      DATABASE_NAME: news_db
      DATABASE_SSLMODE: disable
      KAFKA_BROKERS: kafka:9092
      KAFKA_GROUP_ID: news-service-group
      SERVICE_NAME: news-service
      SERVICE_PORT: "8083"
      SUBSCRIPTION_SERVICE_URL: http://subscription-service:8082
      LOG_LEVEL: ${LOG_LEVEL:-info}
    networks:
      - telegram-news-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pgrep news-service || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Bot Service - Telegram бот для взаимодействия с пользователями
  bot-service:
    build:
      context: ..
      dockerfile: services/bot-service/Dockerfile
    container_name: telegram-news-bot-service
    depends_on:
      - kafka
      - subscription-service
    env_file:
      - ../services/bot-service/.env  # TELEGRAM_BOT_TOKEN
    environment:
      KAFKA_BROKERS: kafka:9092
      KAFKA_GROUP_ID: bot-service-group
      SUBSCRIPTION_SERVICE_GRPC_ADDR: subscription-service:50051
      SERVICE_NAME: bot-service
      SERVICE_PORT: "8081"
      LOG_LEVEL: ${LOG_LEVEL:-info}
    networks:
      - telegram-news-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pgrep bot-service || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # PostgreSQL - единый контейнер для всех сервисов
  postgres:
    image: postgres:15-alpine
    container_name: telegram-news-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres_admin_pass
      POSTGRES_DB: postgres
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    networks:
      - telegram-news-network
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./postgres/init-databases.sh:/docker-entrypoint-initdb.d/init-databases.sh:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Kafka UI (опционально, для удобства разработки)
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: telegram-news-kafka-ui
    depends_on:
      - kafka
    ports:
      - "8080:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: telegram-news-cluster
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
      # Zookeeper не требуется в KRaft режиме
    networks:
      - telegram-news-network

networks:
  telegram-news-network:
    driver: bridge

volumes:
  kafka-data:
  postgres-data:
  account-sessions:
  account-logs:
